id: org.basewinehq.WineWechat
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '23.08'

base: org.winehq.Wine
base-version: stable-23.08
command: weixin.sh

finish-args:
  - --allow=multiarch
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio

inherit-extensions:
  - org.freedesktop.Platform.GL32
  - org.freedesktop.Platform.ffmpeg-full
  - org.freedesktop.Platform.ffmpeg_full.i386
  - org.winehq.Wine.gecko
  - org.winehq.Wine.mono
  - org.winehq.Wine.DLLs

add-extensions:
  org.gnome.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version

  org.gnome.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  com.valvesoftware.Steam.CompatibilityTool:
    subdirectories: true
    directory: share/steam/compatibilitytools.d
    version: stable
    versions: stable;beta;test
    no-autodownload: true
    autodelete: false

  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: stable
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin
    no-autodownload: true
    autodelete: false

x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  ldflags: -L/app/lib32
  append-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: i686-unknown-linux-gnu-gcc
    CXX: i686-unknown-linux-gnu-g++
  libdir: /app/lib32

sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.la'
  - '*.a'

cleanup-commands:
  - mkdir -p /app/utils
  - mkdir -p /app/share/steam/compatibilitytools.d
  - mkdir -p /app/share/vulkan/implicit_layer.d/

modules:
  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/etc ld.so.conf
      - mkdir -p ${FLATPAK_DEST}/{,lib/debug/}lib/i386-linux-gnu/GL
      - mkdir -p ${FLATPAK_DEST}/dlls
      - install -Dm644 org.winehq.WineWechat.appdata.xml -t ${FLATPAK_DEST}/share/appdata
      - |
        icondir=${FLATPAK_DEST}/share/icons/hicolor
        install -Dm644 org.winehq.WineWechat.svg ${icondir}/scalable/apps/org.winehq.WineWechat.svg
        for s in 64 128 256; do
          mkdir -p ${icondir}/${s}x${s}/apps
          rsvg-convert -h ${s} -a -o ${icondir}/${s}x${s}/apps/org.winehq.WineWechat.png ${icondir}/scalable/apps/org.winehq.WineWechat.svg
        done
    sources:
      - type: file
        path: ld.so.conf
      - type: file
        path: org.winehq.WineWechat.svg
      - type: file
        path: org.winehq.WineWechat.appdata.xml

  # - name: ffmpeg
  #   config-opts:
  #     - --enable-libdav1d
  #     - --enable-gpl
  #     - --enable-gnutls
  #     - --enable-vaapi
  #     - --enable-vdpau
  #   cleanup:
  #     - /include
  #     - /lib
  #     - /bin
  #     - /share/doc
  #   sources:
  #     - type: archive
  #       url: https://github.com/xbmc/FFmpeg/archive/refs/tags/4.4.1-Nexus-Alpha1.tar.gz
  #       sha256: abbce62231baffe237e412689c71ffe01bfc83135afd375f1e538caae87729ed


  - name: libactivation
    buildsystem: simple
    build-commands:
      - ar -p kylin-activation_1.3.11-4_amd64.deb data.tar.xz > data.tar.xz
      - tar xvf data.tar.xz
      - mkdir -p /app/lib/
      - cp -r ./usr/lib/* /app/lib/
    cleanup:
      - ./

    sources:
      - type: file
        url: https://archive2.kylinos.cn/deb/kylin/Library/KY-V10-SP1-amd64/custom/kylin-desktop/V10-SP1-amd64/pool/all/kylin-activation_1.3.11-4_amd64.deb
        sha256: c33de429bfdf8ce11757e96e611c0982196c9933ec157bccb7b18da8617b0e9c

  - name: wechat
    buildsystem: simple
    build-commands:
      - install -Dm644 org.winehq.WineWechat.desktop /app/share/applications/org.winehq.WineWechat.desktop
      - install -Dm644 org.winehq.WineWechat.svg /app/share/icons/hicolor/scalable/apps/org.winehq.WineWechat.svg

      - ar -p weixin_2.1.9_amd64.deb data.tar.xz > data.tar.xz
      - mkdir -p /app/weixin/
      - tar xvf data.tar.xz -C /app/weixin/
      - chmod +x /app/weixin/opt/weixin/weixin.sh
      - install -Dm777 weixin.sh /app/bin/weixin.sh
      - install -D lsb-release /app/weixin/lsb-release
    sources:
      - type: file
        url: https://archive2.kylinos.cn/deb/kylin/production/PART-V10-SP1/custom/partner/V10-SP1/pool/all/weixin_2.1.9_amd64.deb
        sha256: f530db6d29b140d8adf75132baa7f61033ff444e8cd558deb9411e905adfeb45
      - type: file
        path: org.winehq.WineWechat.desktop
      - type: file
        path: org.winehq.WineWechat.svg
      - type: file
        path: weixin.sh
      - type: file
        path: lsb-release
